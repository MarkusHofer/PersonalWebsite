---
import Link from '@/components/Link.astro'
import ThemeToggle from '@/components/ThemeToggle.astro'
import { NAV_LINKS, SITE } from '@/consts'
import { Icon } from 'astro-icon/components'
---

<div>
  <div
    class="mx-auto flex max-w-3xl items-center justify-between gap-4 px-4 py-3"
  >
    <Link href="/" class="flex shrink-0 items-center justify-center">
      <span class="text-lg leading-none font-medium">{SITE.title}</span>
    </Link>

    <!-- Desktop Navigation -->
    <div class="hidden items-center gap-4 sm:flex">
      <nav class="flex items-center gap-6 text-sm">
        {
          NAV_LINKS.map((item) => (
            <Link
              href={item.href}
              class="text-foreground/60 hover:text-foreground capitalize transition-colors"
            >
              {item.label}
            </Link>
          ))
        }
      </nav>
      <ThemeToggle transition:persist />
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-button"
      class="text-foreground/60 hover:text-foreground flex items-center p-1 transition-colors sm:hidden"
      aria-label="Toggle menu"
      aria-expanded="false"
    >
      <Icon name="lucide:menu" class="size-5" id="menu-icon-open" />
      <Icon name="lucide:x" class="hidden size-5" id="menu-icon-close" />
    </button>
  </div>
</div>

<!-- Full-screen Mobile Menu -->
<div
  id="mobile-menu"
  class="bg-background fixed inset-0 z-[60] hidden h-screen w-screen flex-col sm:hidden"
>
  <!-- Close button in top right -->
  <div class="flex justify-end p-4">
    <button
      id="mobile-menu-close"
      class="text-foreground/60 hover:text-foreground p-2 transition-colors"
      aria-label="Close menu"
    >
      <Icon name="lucide:x" class="size-6" />
    </button>
  </div>

  <!-- Navigation items at bottom right -->
  <div class="flex flex-1 flex-col items-end justify-end p-8 pb-20">
    <nav class="flex flex-col items-end gap-8">
      {
        NAV_LINKS.map((item) => (
          <Link
            href={item.href}
            class="mobile-menu-link text-foreground/80 hover:text-foreground text-3xl font-medium capitalize transition-colors leading-none"
          >
            {item.label}
          </Link>
        ))
      }
    </nav>
    <div class="mt-12 flex items-center justify-end">
      <ThemeToggle />
    </div>
  </div>
</div>

<script>
  function setupMobileMenu() {
    const menuButton = document.getElementById('mobile-menu-button')
    const closeButton = document.getElementById('mobile-menu-close')
    const mobileMenu = document.getElementById('mobile-menu')
    const iconOpen = document.getElementById('menu-icon-open')
    const iconClose = document.getElementById('menu-icon-close')

    if (!menuButton || !mobileMenu || !iconOpen || !iconClose) return

    let isOpen = false

    function toggleScrollLock() {
      document.body.classList.toggle('overflow-hidden', isOpen)
    }

    function trapFocus(e: KeyboardEvent) {
      if (!isOpen) return
      
      const focusableElements = mobileMenu?.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      )
      if (!focusableElements || focusableElements.length === 0) return

      const firstElement = focusableElements[0] as HTMLElement
      const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement

      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault()
            lastElement.focus()
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault()
            firstElement.focus()
          }
        }
      }
    }

    function openMenu() {
      if (!mobileMenu || !iconOpen || !iconClose) return
      isOpen = true
      mobileMenu.classList.remove('hidden')
      mobileMenu.classList.add('flex')
      iconOpen.classList.add('hidden')
      iconClose.classList.remove('hidden')
      menuButton?.setAttribute('aria-expanded', 'true')
      toggleScrollLock()
      
      // Focus management
      closeButton?.focus()
      document.addEventListener('keydown', trapFocus)
    }

    function closeMenu() {
      if (!isOpen || !mobileMenu || !iconOpen || !iconClose) return
      isOpen = false
      mobileMenu.classList.add('hidden')
      mobileMenu.classList.remove('flex')
      iconOpen.classList.remove('hidden')
      iconClose.classList.add('hidden')
      menuButton?.setAttribute('aria-expanded', 'false')
      toggleScrollLock()
      
      document.removeEventListener('keydown', trapFocus)
      menuButton?.focus()
    }

    menuButton.addEventListener('click', openMenu)
    closeButton?.addEventListener('click', closeMenu)

    // Close when clicking a link
    mobileMenu.querySelectorAll('.mobile-menu-link').forEach((link) => {
      link.addEventListener('click', () => {
        closeMenu()
      })
    })

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) closeMenu()
    })
  }

  document.addEventListener('astro:page-load', setupMobileMenu)
  document.addEventListener('astro:after-swap', setupMobileMenu)
</script>
