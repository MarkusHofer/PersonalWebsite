---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import { CopyCitation } from '@/components/CopyCitation'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Badge } from '@/components/ui/badge'
import {
  loadPublications,
  filterPeerReviewed,
  filterGuestEditorships,
  sortPublicationsByYear,
  generateBibtex,
} from '@/lib/bibtex-utils'
import { Icon } from 'astro-icon/components'

const allPublications = await loadPublications()
const peerReviewed = sortPublicationsByYear(filterPeerReviewed(allPublications))
const guestEditorships = sortPublicationsByYear(filterGuestEditorships(allPublications))
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title="Publications" />
  <Breadcrumbs items={[{ label: 'Publications', icon: 'lucide:book-open' }]} />

  <section class="flex flex-col gap-y-8">
    <!-- Peer-Reviewed Publications Section -->
    {peerReviewed.length > 0 && (
      <section class="flex flex-col gap-y-4">
        <h2 class="text-xl font-medium">Peer-Reviewed</h2>
        <ul class="flex flex-col gap-4">
          {peerReviewed.map((pub) => (
            <li class="grid grid-cols-[1fr] sm:grid-cols-[3rem_1fr] gap-x-4 gap-y-2 border-b border-border/50 pb-4 last:border-0 last:pb-0">
              <div class="font-bold text-muted-foreground pt-1">{pub.year}</div>
              <div class="flex flex-col gap-1">
                <div class="flex items-start justify-between gap-4">
                  <div class="font-medium text-lg leading-snug">{pub.title}</div>
                  {pub.keywords && pub.keywords.length > 0 && (
                    <div class="flex flex-wrap gap-1.5 shrink-0 mt-1">
                      {pub.keywords.map((keyword) => (
                        <Badge variant="theme2" className="text-[10px] px-1.5 py-0 h-5">
                          {keyword}
                        </Badge>
                      ))}
                    </div>
                  )}
                </div>
                <div class="text-sm text-muted-foreground leading-relaxed">
                  {pub.authors.map((author, index) => (
                    <>
                      {author.includes('Hofer') ? (
                        <span class="font-medium text-foreground">{author}</span>
                      ) : (
                        author
                      )}
                      {index < pub.authors.length - 1 && ', '}
                    </>
                  ))}
                </div>
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-2.5">
                  <div class="flex flex-col gap-1 flex-1">
                    {pub.venue && (
                      <div class="text-sm italic text-muted-foreground">{pub.venue}</div>
                    )}
                    <div class="flex flex-wrap gap-x-5 gap-y-1 text-sm text-muted-foreground">
                      {pub.volume && pub.number && (
                        <span>
                          Vol. {pub.volume}, No. {pub.number}
                        </span>
                      )}
                      {pub.pages && <span>pp. {pub.pages}</span>}
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-x-5 gap-y-1 shrink-0">
                    {pub.doi ? (
                      <Link
                        href={`https://doi.org/${pub.doi}`}
                        external
                        class="text-sm text-primary hover:underline flex items-center gap-1.5"
                      >
                        <Icon name="lucide:external-link" class="w-3.5 h-3.5" />
                        DOI
                      </Link>
                    ) : pub.url && (
                      <Link
                        href={pub.url}
                        external
                        class="text-sm text-primary hover:underline flex items-center gap-1.5"
                      >
                        <Icon name="lucide:external-link" class="w-3.5 h-3.5" />
                        Link
                      </Link>
                    )}
                    <CopyCitation bibtex={generateBibtex(pub)} client:load />
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- Guest Editorships Section -->
    {guestEditorships.length > 0 && (
      <section class="flex flex-col gap-y-4">
        <h2 class="text-xl font-medium">Guest Editorships</h2>
        <ul class="flex flex-col gap-4">
          {guestEditorships.map((pub) => (
            <li class="grid grid-cols-[1fr] sm:grid-cols-[3rem_1fr] gap-x-4 gap-y-2 border-b border-border/50 pb-4 last:border-0 last:pb-0">
              <div class="font-bold text-muted-foreground pt-1">{pub.year}</div>
              <div class="flex flex-col gap-1">
                <div class="flex items-start justify-between gap-4">
                  <div class="font-medium text-lg leading-snug">{pub.title}</div>
                  {pub.keywords && pub.keywords.length > 0 && (
                    <div class="flex flex-wrap gap-1.5 shrink-0 mt-1">
                      {pub.keywords.map((keyword) => (
                        <Badge variant="theme2" className="text-[10px] px-1.5 py-0 h-5">
                          {keyword}
                        </Badge>
                      ))}
                    </div>
                  )}
                </div>
                <div class="text-sm text-muted-foreground leading-relaxed">
                  {pub.authors.map((author, index) => (
                    <>
                      {author.includes('Hofer') ? (
                        <span class="font-medium text-foreground">{author}</span>
                      ) : (
                        author
                      )}
                      {index < pub.authors.length - 1 && ', '}
                    </>
                  ))}
                  <span class="italic ml-1">(Eds.)</span>
                </div>
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-2.5">
                  <div class="flex flex-col gap-1 flex-1">
                    {pub.venue && (
                      <div class="text-sm italic text-muted-foreground">{pub.venue}</div>
                    )}
                    <div class="flex flex-wrap gap-x-5 gap-y-1 text-sm text-muted-foreground">
                      {pub.volume && pub.number && (
                        <span>
                          Vol. {pub.volume}, No. {pub.number}
                        </span>
                      )}
                      {pub.pages && <span>pp. {pub.pages}</span>}
                      {pub.note && <span>{pub.note}</span>}
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-x-5 gap-y-1 shrink-0">
                    {pub.doi ? (
                      <Link
                        href={`https://doi.org/${pub.doi}`}
                        external
                        class="text-sm text-primary hover:underline flex items-center gap-1.5"
                      >
                        <Icon name="lucide:external-link" class="w-3.5 h-3.5" />
                        DOI
                      </Link>
                    ) : pub.url && (
                      <Link
                        href={pub.url}
                        external
                        class="text-sm text-primary hover:underline flex items-center gap-1.5"
                      >
                        <Icon name="lucide:external-link" class="w-3.5 h-3.5" />
                        Link
                      </Link>
                    )}
                    <CopyCitation bibtex={generateBibtex(pub)} client:load />
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </section>
    )}

    {peerReviewed.length === 0 && guestEditorships.length === 0 && (
      <div class="prose">
        <p>No publications found. Please add entries to your BibTeX file.</p>
      </div>
    )}
  </section>
</Layout>
